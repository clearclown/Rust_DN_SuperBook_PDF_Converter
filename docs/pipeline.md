# 処理パイプライン

superbook-pdf の画像処理パイプラインの詳細設計です。

---

## 概要

```
入力PDF
  │
  ├─ 1.  PDF画像抽出
  ├─ 2.  マージントリム
  ├─ 3.  影除去
  ├─ 4.  AI超解像
  ├─ 5.  ブレ補正
  ├─ 6.  180度回転検出
  ├─ 7.  傾き補正 (deskew)
  ├─ 8.  カラー補正
  ├─ 9.  マーカー除去
  ├─ 10. グループクロップ
  ├─ 11. PDF生成
  └─ 12. OCR
  │
  出力PDF
```

空白ページは Step 1 直後に自動検出 (白ピクセル比率 > 98%) され、以降の全ステップをスキップします。

---

## Step 1: PDF 画像抽出

**ツール:** `pdftoppm` (Poppler)

PDF の各ページを指定 DPI で PNG 画像として抽出します。

- デフォルト DPI: 300
- 出力形式: PNG (ロスレス)
- 並列処理: ページ単位で `rayon` による並列化

## Step 2: マージントリム

**モジュール:** `src/margin/detect.rs`

ページ端の余白を除去します。

- デフォルト率: 0.7%
- コンテンツ認識マージン検出 (デフォルト ON): 文字領域を検出し、文字が切れないようにトリム
- 安全バッファ: 0.5% (調整可能)
- RGBA → RGB 強制変換

### コンテンツ認識の仕組み

`src/margin/content_aware.rs` で実装。大津二値化でテキスト領域を検出し、コネクテッドコンポーネント解析で文字候補を抽出。文字のバウンディングボックスから安全なトリム境界を算出します。

## Step 3: 影除去

**モジュール:** `src/margin/shadow.rs`

製本時の影 (ノド部分) を検出・除去します。

- モード: `none` / `auto` / `left` / `right` / `both`
- 自動モードでは、ページ端の輝度勾配を分析して影の有無と位置を判定

## Step 4: AI 超解像

**モジュール:** `src/realesrgan.rs` → `ai_bridge/realesrgan_bridge.py`

RealESRGAN による 2x アップスケーリング。

- モデル: RealESRGAN_x2plus (自動ダウンロード)
- GPU 必須 (CUDA)
- Python ブリッジ経由で実行
- `SUPERBOOK_VENV` 環境変数でvenvパスを指定

## Step 5: ブレ補正

**モジュール:** `src/cleanup/deblur.rs`

ぼやけた画像のシャープ化。3つのアルゴリズムを選択可能。

| アルゴリズム | 処理 | GPU | 品質 |
|------------|------|-----|------|
| Unsharp Mask | ローカル畳み込み | 不要 | 中 |
| NAFNet | AI推論 | 必要 | 高 |
| DeblurGAN-v2 | AI推論 | 必要 | 高 |

AI超解像で解像度が上がった後にシャープ化するため、Step 4 の後に配置しています。

## Step 6: 180度回転検出

**モジュール:** `src/deskew/algorithm.rs`

上下逆のページを自動検出して180度回転します。

### 検出アルゴリズム

1. 大津二値化で前景 (インク) を抽出
2. 上部 25% と下部 25% のインクピクセル密度を比較
3. 上部 10% と下部 10% の密度も比較
4. `下部/上部 > 2.0` かつ `下10%/上10% > 1.5` なら上下逆と判定

日本語書籍ではページ下部にページ番号が集中するため、この比率で判定できます。

## Step 7: 傾き補正 (Deskew)

**モジュール:** `src/deskew/algorithm.rs`

スキャン時の微小な傾きを検出・補正します。

### アルゴリズム

1. **大津二値化** - 自動閾値で文字領域を抽出
2. **モルフォロジー開** - ノイズ除去
3. **Hough変換** - 直線検出で傾き角度を推定
4. **WarpAffine** - アフィン変換で回転補正

### 信頼度フィルタ

- 特徴点 < 10 または信頼度 < 0.1 の場合はスキップ (過補正防止)

## Step 8: カラー補正

**モジュール:** `src/color_stats.rs`

HSV 色空間での裏写り抑制と紙色の白化。

- 色相範囲: 20-65 (黄〜オレンジ = 紙色・裏写り)
- 彩度最大: 0.3
- 明度最小: 0.7
- コントラストブースト: 1.08x (非紙色ピクセル)

デフォルトで有効 (`color_correction: true`)。

## Step 9: マーカー除去

**モジュール:** `src/cleanup/marker_removal.rs`

蛍光ペンのハイライトを検出・除去します。

- HSV色空間でマーカー色を検出
- 対応色: 黄、ピンク、緑、青、オレンジ
- カラー補正後に実行 (グローバル色補正でHSV検出が安定するため)

## Step 10: グループクロップ

**モジュール:** `src/margin/group.rs`

全ページで均一なマージンを実現します。

1. 各ページのコンテンツ境界を検出
2. 全ページのバウンディングボックスから共通領域を算出
3. 10% のマージン拡張
4. 均一にクロップ

## Step 11: PDF 生成

**モジュール:** `src/pdf_writer.rs`

処理済み画像から PDF を生成します。

- JPEG DCT 圧縮 (指定品質)
- フォント: 1回のみ読み込み (メモリ効率)
- メタデータ同期 (元 PDF のタイトル、著者等)

## Step 12: OCR

**モジュール:** `src/yomitoku.rs` → `ai_bridge/yomitoku_bridge.py`

YomiToku による日本語 AI OCR。`--ocr` オプション指定時のみ実行。

- テキストレイヤーを PDF に埋め込み
- 検索可能 PDF を生成

---

## Markdown パイプライン

`markdown` コマンドは専用のパイプライン (`src/markdown_pipeline.rs`) を使用します。

```
入力PDF
  │
  ├─ 1. PDF画像抽出
  ├─ 2. マージントリム
  ├─ 3. AI超解像 (任意)
  ├─ 4. 180度回転検出
  ├─ 5. 傾き補正
  ├─ 6. 図検出・分類
  ├─ 7. OCR (YomiToku)
  ├─ 8. Markdown生成
  └─ 9. ページ結合
  │
  出力Markdown + 画像
```

### Markdown 生成の品質フィルタ

`src/markdown_gen.rs` の `normalize_markdown()` で以下の後処理を適用:

- **ページ番号除去**: 1-4桁の数字のみの行を除去
- **ふりがな除去**: 短いひらがな/カタカナ + スペースの行を除去
- **見出し変換**: `+heading` 形式を `## heading` に変換
- **OCR ノイズ除去**: 全大文字ASCII (3文字以下) を除去
- **重複行除去**: 連続する同一行・近似行を除去
- **末尾ノイズ除去**: 行末の短いノイズトークンを除去

---

## 並列処理

ほとんどのステップは `rayon` による並列処理に対応しています。`--threads` で並列度を制御できます。

`--chunk-size` を指定すると、メモリ使用量を制御するためにチャンク単位で処理します (デフォルト: 0 = 一括処理)。
